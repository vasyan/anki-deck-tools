<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Example Generation - Anki Vector Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-brain"></i> Anki Vector Admin
            </a>
            <span class="navbar-text">
                <i class="fas fa-robot"></i> Example Generation
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">ü§ñ Example Generation</h1>
                <p class="text-muted">Generate examples for your Anki learning contents using AI language models</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog"></i> Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="example-form">
                            <div class="mb-3">
                                <label for="deck" class="form-label">Deck Name</label>
                                <select class="form-select" id="deck" name="deck">
                                    <option value="">All decks</option>
                                </select>
                                <div class="form-text">Select a specific deck or choose "All decks"</div>
                            </div>

                            <div class="mb-3">
                                <label for="learning_content_id" class="form-label">Learning Content ID (optional)</label>
                                <input type="number" class="form-control" id="learning_content_id" name="learning_content_id" 
                                       placeholder="Enter specific learning content ID for testing"
                                       value="52">

                                <div class="form-text">
                                    <i class="fas fa-info-circle text-info"></i> 
                                    If specified, only this learning content will be processed (overrides deck selection)
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="columns" class="form-label">Learning Content Columns <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="columns" name="columns" 
                                       value="title" required>
                                <div class="form-text">Comma-separated list of learning content columns to use in template</div>
                            </div>

                            <div class="mb-3">
                                <label for="instructions_file" class="form-label">Instruction Template <span class="text-danger">*</span></label>
                                <select class="form-select" id="instructions_file" name="instructions_file" required>
                                    <option value="">Select instruction template...</option>
                                </select>
                                <div class="form-text">Select from available instruction templates</div>
                            </div>

                            <div class="mb-3">
                                <label for="limit" class="form-label">Limit (optional)</label>
                                <input type="number" class="form-control" id="limit" name="limit" 
                                       min="1" max="10000" placeholder="No limit">
                                <div class="form-text">Maximum number of learning contents to process</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="with_preview" name="with_preview" checked>
                                    <label class="form-check-label" for="with_preview">
                                        With Preview
                                    </label>
                                </div>
                                <div class="form-text text-warning">
                                    <i class="fas fa-info-circle"></i> 
                                    Preview mode will show sample results before processing (disables parallel processing)
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="parallel" name="parallel" checked>
                                    <label class="form-check-label" for="parallel">
                                        Enable Parallel Processing
                                    </label>
                                </div>
                                <div class="form-text">Process learning contents in parallel for faster performance</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dry_run" name="dry_run" checked>
                                    <label class="form-check-label" for="dry_run">
                                        Dry Run (Preview Only)
                                    </label>
                                </div>
                                <div class="form-text">Generate examples without saving to database</div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success" id="submit-btn">
                                    <i class="fas fa-magic"></i> Generate Examples
                                </button>
                                <a href="/admin" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div id="result-container">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Ready to Generate
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h6>‚ÑπÔ∏è Getting Started</h6>
                                <ul class="mb-0">
                                    <li>Select an instruction template from the dropdown</li>
                                    <li>Configure your columns and processing options</li>
                                    <li>Use "With Preview" to see sample results first</li>
                                    <li>Enable "Dry Run" to test without saving</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">
                        <i class="fas fa-eye"></i> Preview Results
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="preview-content">
                    <!-- Preview content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="proceed-after-preview">
                        <i class="fas fa-check"></i> Proceed with Generation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class ExampleGenerationManager {
            constructor() {
                this.form = document.getElementById('example-form');
                this.submitBtn = document.getElementById('submit-btn');
                this.resultContainer = document.getElementById('result-container');
                this.previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                
                this.setupEventListeners();
                this.loadInstructionFiles();
                this.loadAvailableDecks();
            }

            setupEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleFormSubmit(e));
                
                // Preview mode disables parallel processing
                document.getElementById('with_preview').addEventListener('change', (e) => {
                    const parallelCheckbox = document.getElementById('parallel');
                    if (e.target.checked) {
                        parallelCheckbox.checked = false;
                        parallelCheckbox.disabled = true;
                    } else {
                        parallelCheckbox.disabled = false;
                    }
                });

                // Learning Content ID input affects deck selection
                document.getElementById('learning_content_id').addEventListener('input', (e) => {
                    const deckSelect = document.getElementById('deck');
                    const limitInput = document.getElementById('limit');
                    
                    if (e.target.value.trim()) {
                        // If learning content ID is specified, disable deck selection and limit
                        deckSelect.disabled = true;
                        limitInput.disabled = true;
                        deckSelect.title = 'Disabled when Learning Content ID is specified';
                        limitInput.title = 'Disabled when Learning Content ID is specified';
                    } else {
                        // If learning content ID is empty, re-enable deck selection and limit
                        deckSelect.disabled = false;
                        limitInput.disabled = false;
                        deckSelect.title = '';
                        limitInput.title = '';
                    }
                });

                // Proceed after preview
                document.getElementById('proceed-after-preview').addEventListener('click', () => {
                    this.previewModal.hide();
                    this.startGeneration();
                });
            }

            async loadInstructionFiles() {
                try {
                    const response = await fetch('/admin/example/instructions');
                    const data = await response.json();
                    
                    const select = document.getElementById('instructions_file');
                    select.innerHTML = '<option value="">Select instruction template...</option>';
                    
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.path;
                        option.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                        select.appendChild(option);
                    });
                    select.value = data.files[0].path;
                } catch (error) {
                    console.error('Error loading instruction files:', error);
                    this.showError('Failed to load instruction files');
                }
            }

            async loadAvailableDecks() {
                try {
                    const response = await fetch('/admin/example/decks');
                    const data = await response.json();
                    
                    const select = document.getElementById('deck');
                    // Keep the "All decks" option as first option
                    select.innerHTML = '<option value="">All decks</option>';
                    
                    data.decks.forEach(deckName => {
                        const option = document.createElement('option');
                        option.value = deckName;
                        option.textContent = deckName;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading available decks:', error);
                    // Don't show error for decks loading failure - just keep the "All decks" option
                    console.warn('Failed to load deck list, using "All decks" option only');
                }
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(this.form);
                const withPreview = formData.get('with_preview') === 'on';
                
                if (withPreview) {
                    await this.showPreview(formData);
                } else {
                    await this.startGeneration();
                }
            }

            async showPreview(formData) {
                try {
                    this.submitBtn.disabled = true;
                    this.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Preview...';
                    
                    const response = await fetch('/admin/example/preview', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.displayPreview(data);
                    this.previewModal.show();
                    
                } catch (error) {
                    this.showError(`Preview failed: ${error.message}`);
                } finally {
                    this.submitBtn.disabled = false;
                    this.submitBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Examples';
                }
            }

            displayPreview(data) {
                const previewContent = document.getElementById('preview-content');
                
                let html = `
                    <div class="alert alert-info">
                        <h6>üìã Preview Summary</h6>
                        <p><strong>Learning Contents in preview:</strong> ${data.total_learning_contents}</p>
                        <p><strong>Template:</strong> ${data.template}</p>
                    </div>
                `;
                
                if (data.preview_results && data.preview_results.length > 0) {
                    html += '<div class="accordion" id="previewAccordion">';
                    
                    data.preview_results.forEach((result, index) => {
                        const status = result.status === 'success' ? 'success' : 'danger';
                        const icon = result.status === 'success' ? 'check' : 'times';
                        
                        html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading${index}">
                                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                        <i class="fas fa-${icon} text-${status} me-2"></i>
                                        Learning Content ${result.learning_content_id} - ${result.deck_name}
                                    </button>
                                </h2>
                                <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                     data-bs-parent="#previewAccordion">
                                    <div class="accordion-body">
                                        <h6>Learning Content Data:</h6>
                                        <pre class="bg-light p-2 rounded">${JSON.stringify(result.learning_content_data, null, 2)}</pre>
                                        
                                        ${result.status === 'success' ? `
                                            <h6>Generated Example:</h6>
                                            <div class="alert alert-success">
                                                ${result.generated_example}
                                            </div>
                                        ` : `
                                            <h6>Error:</h6>
                                            <div class="alert alert-danger">
                                                ${result.error}
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += '<div class="alert alert-warning">No preview results available</div>';
                }
                
                previewContent.innerHTML = html;
            }

            async startGeneration() {
                try {
                    const formData = new FormData(this.form);
                    if (formData.get('with_preview') === 'on') {
                        formData.delete('with_preview');
                    }
                    
                    this.submitBtn.disabled = true;
                    this.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
                    
                    const response = await fetch('/admin/example/start', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.showInitialStatus(data.task_id);
                    this.pollTaskStatus(data.task_id);
                    
                } catch (error) {
                    this.showError(`Generation failed: ${error.message}`);
                    this.submitBtn.disabled = false;
                    this.submitBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Examples';
                }
            }

            showInitialStatus(taskId) {
                this.resultContainer.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog fa-spin"></i> Processing
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: 0%">0%</div>
                            </div>
                            <div id="status-message" class="alert alert-info">
                                ü§ñ Starting example generation...
                            </div>
                            <div id="results-content"></div>
                        </div>
                    </div>
                `;
            }

            async pollTaskStatus(taskId) {
                try {
                    const response = await fetch(`/admin/example/status/${taskId}`);
                    const data = await response.json();
                    
                    this.updateProgress(data.progress, data.message);
                    
                    if (data.status === 'completed') {
                        this.showResults(data.result);
                        this.submitBtn.disabled = false;
                        this.submitBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Examples';
                    } else if (data.status === 'error') {
                        this.showError(data.message);
                        this.submitBtn.disabled = false;
                        this.submitBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Examples';
                    } else if (data.status === 'running') {
                        setTimeout(() => this.pollTaskStatus(taskId), 2000);
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    setTimeout(() => this.pollTaskStatus(taskId), 5000);
                }
            }

            updateProgress(progress, message) {
                const progressBar = document.getElementById('progress-bar');
                const statusMessage = document.getElementById('status-message');
                
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                }
                
                if (statusMessage) {
                    statusMessage.textContent = message;
                }
            }

            showResults(result) {
                const resultsContent = document.getElementById('results-content');
                const statusMessage = document.getElementById('status-message');
                
                if (statusMessage) {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.textContent = `‚úÖ Example generation completed! Success: ${result.successful}, Failed: ${result.failed}`;
                }
                
                let html = `
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">${result.processed_cards}</h4>
                                <small class="text-muted">Processed</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">${result.successful}</h4>
                                <small class="text-muted">Successful</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-danger">${result.failed}</h4>
                                <small class="text-muted">Failed</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">${result.processing_time.toFixed(2)}s</h4>
                                <small class="text-muted">Processing Time</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show dry run results if available
                if (result.dry_run && result.dry_run_results && result.dry_run_results.length > 0) {
                    html += `
                        <div class="mt-3">
                            <h6>üîç Dry Run Results (Sample)</h6>
                            <div class="accordion" id="dryRunAccordion">
                    `;
                    
                    result.dry_run_results.forEach((dryResult, index) => {
                        html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="dryHeading${index}">
                                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#dryCollapse${index}">
                                        Learning Content ${dryResult.learning_content_id} - ${dryResult.deck_name}
                                    </button>
                                </h2>
                                <div id="dryCollapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                     data-bs-parent="#dryRunAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Title:</strong> ${dryResult.title}</p>
                                        <p><strong>Generated Example:</strong></p>
                                        <div class="alert alert-light">
                                            ${dryResult.generated_example}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                // Show failed cards if any
                if (result.failed_learning_contents && result.failed_learning_contents.length > 0) {
                    html += `
                        <div class="mt-3">
                            <h6>‚ùå Failed Learning Contents</h6>
                            <div class="alert alert-danger">
                                <ul class="mb-0">
                    `;
                    
                    result.failed_learning_contents.forEach(failedLearningContent => {
                        html += `<li>Learning Content ${failedLearningContent.learning_content_id}: ${failedLearningContent.error}</li>`;
                    });
                    
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                if (resultsContent) {
                    resultsContent.innerHTML = html;
                }
            }

            showError(message) {
                this.resultContainer.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0 text-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger">
                                ${message}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the manager when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ExampleGenerationManager();
        });
    </script>
</body>
</html> 
