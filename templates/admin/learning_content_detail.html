<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Content Details - Anki Vector Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tag {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 0.8em;
        }
        .fragment-card {
            border-left: 4px solid #6c757d;
            margin-bottom: 15px;
        }
        .fragment-card.vocabulary {
            border-left-color: #0d6efd;
        }
        .fragment-card.real_life_example {
            border-left-color: #198754;
        }
        .fragment-card.pronunciation {
            border-left-color: #dc3545;
        }
        .fragment-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .loading-spinner {
            display: none;
        }
        .btn-playing {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }
        .btn-playing:hover {
            background-color: #157347;
            color: white;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .icon-pulse {
            animation: pulse 1s infinite;
            display: inline-block;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark py-0">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-brain"></i> Anki Vector Admin
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/admin">Dashboard</a>
                <a class="nav-link me-3" href="/admin/fragments">Fragments</a>
                <a class="nav-link active" href="/admin/learning-content">Learning Content</a>
            </div>
        </div>
    </nav>

    <div class="container mt-2">
        <div class="row mb-1">
            <div class="col-12">
                <a href="/admin/learning-content" class="btn btn-outline-secondary mb-2">
                    <i class="fas fa-arrow-left"></i> Back to Learning Content
                </a>
                <button class="btn btn-outline-secondary mb-2" type="button" onclick="navigateToPrevious()" id="prevBtn" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="btn btn-outline-secondary mb-2" type="button" onclick="navigateToNext()" id="nextBtn" style="display: none;">
                    <i class="fas fa-arrow-right"></i> Next
                </button>
                <button class="btn btn-primary mb-2" type="button" onclick="finishReview()" id="finishReviewBtn" style="display: none;">
                    <i class="fas fa-check-circle"></i> Finish Review
                </button>
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 id="contentTitle" class="mb-0">Learning Content Details</h4>
                            <div class="d-flex align-items-center">
                                <span id="contentIdDisplay" class="badge bg-secondary me-2" style="display: none;">ID: </span>
                                <div class="loading-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-1" id="contentDetails">
                        <!-- Content details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Fragments Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-puzzle-piece text-primary"></i> Related Fragments</h5>
                    </div>
                    <div class="card-body">
                        <div id="fragmentsList">
                            <!-- Fragments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check if we're in review mode
        const isReviewMode = window.location.pathname.includes('/review');
        let contentId = null;
        
        if (!isReviewMode) {
            // Get content ID from URL for detail mode
            // url looks like /learning-content/52/detail
            contentId = window.location.pathname.split('/').filter(v => /^\d+$/.test(v))[0];
        }

        document.addEventListener('DOMContentLoaded', async function() {
            if (isReviewMode) {
                // In review mode, first get the next content to review
                await loadNextReviewContent();
            } else {
                // In detail mode, load the specific content
                loadContentDetails();
                loadContentFragments();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (isReviewMode) {
                // In review mode, only handle Enter key to finish review
                if (event.key === 'Enter') {
                    finishReview();
                }
            } else {
                // In detail mode, handle arrow keys for navigation
                if (event.key === 'ArrowLeft') {
                    navigateToPrevious();
                } else if (event.key === 'ArrowRight') {
                    navigateToNext();
                }
            }
        });

        // Show/hide loading
        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        async function loadContentDetails() {
            if (isReviewMode) return;  // Skip in review mode
            
            // Show navigation buttons in detail mode
            document.getElementById('prevBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('finishReviewBtn').style.display = 'none';
            
            showLoading(true);
            try {
                const response = await fetch(`/learning-content/${contentId}`);

                if (!response.ok) {
                    // Handle 404 or other errors
                    if (response.status === 404) {
                        document.getElementById('contentDetails').innerHTML =
                            '<div class="alert alert-warning">' +
                            '<h4><i class="fas fa-exclamation-triangle"></i> Content Not Found</h4>' +
                            '<p>The learning content you\'re looking for doesn\'t exist.</p>' +
                            '<p>This may be because:</p>' +
                            '<ul>' +
                            '<li>The content was deleted</li>' +
                            '<li>The database is not properly set up</li>' +
                            '<li>The content ID is incorrect</li>' +
                            '</ul>' +
                            '</div>';
                    } else {
                        document.getElementById('contentDetails').innerHTML =
                            '<div class="alert alert-danger">' +
                            `<h4><i class="fas fa-exclamation-circle"></i> Error (${response.status})</h4>` +
                            '<p>There was a problem loading the content details. Please try again later.</p>' +
                            '</div>';
                    }
                    return;
                }

                const content = await response.json();
                displayContentDetails(content);
            } catch (error) {
                console.error('Error loading content details:', error);
                document.getElementById('contentDetails').innerHTML =
                    '<div class="alert alert-danger">' +
                    '<h4><i class="fas fa-exclamation-circle"></i> Error</h4>' +
                    '<p>There was a problem loading the content details:</p>' +
                    `<pre class="text-danger">${error.message}</pre>` +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }

        async function loadContentFragments() {
            showLoading(true);
            try {
                const response = await fetch(`/learning-content/${contentId}/fragments?order_by=created_at`);

                if (!response.ok) {
                    // Handle errors but don't show an alert - just show empty state
                    document.getElementById('fragmentsList').innerHTML =
                        '<div class="alert alert-info">' +
                        '<p><i class="fas fa-info-circle"></i> No fragments found for this content.</p>' +
                        '</div>';
                    return;
                }

                const fragments = await response.json();
                displayFragments(fragments);
            } catch (error) {
                console.error('Error loading fragments:', error);
                document.getElementById('fragmentsList').innerHTML =
                    '<div class="alert alert-info">' +
                    '<p><i class="fas fa-info-circle"></i> No fragments could be loaded at this time.</p>' +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }

        function displayContentDetails(content) {
            // Update page title
            document.title = `${content.title} - Learning Content Details`;
            document.getElementById('contentTitle').textContent = content.title;

            // Show and update content ID display
            const idDisplay = document.getElementById('contentIdDisplay');
            idDisplay.textContent = `ID: ${content.id}`;
            idDisplay.style.display = 'inline-block';

            // Format tags for display
            const tagsHtml = content.tags ?
                content.tags.map(tag => `<span class="tag">${tag}</span>`).join('') :
                '<em class="text-muted">None</em>';

            let html = `
                <div class="row mb-1">
                    <div class="col-md-6">
                        <div class="mb-1">
                            <span class="badge bg-primary">${content.content_type}</span>
                            ${content.difficulty_level ?
                              `<span class="badge bg-warning ms-1">Level ${content.difficulty_level}</span>` : ''}
                            <span class="badge bg-secondary ms-1">${content.language}</span>
                        </div>
                        <p class="mb-0"><strong>Tags:</strong> ${tagsHtml}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-0"><small class="text-muted">Created: ${new Date(content.created_at).toLocaleDateString()}</small></p>
                        <p class="mb-0"><small class="text-muted">Last Updated: ${new Date(content.updated_at).toLocaleDateString()}</small></p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-1">
                        <h6>Thai / translation:</h6>
                        <div class="p-1 px-3 bg-light rounded">${content.native_text} / ${content.translation}</div>
                    </div>
                </div>
            `;

            document.getElementById('contentDetails').innerHTML = html;
        }

        function displayFragments(fragments) {
            if (!fragments || fragments.length === 0) {
                document.getElementById('fragmentsList').innerHTML =
                    '<div class="alert alert-info">No fragments associated with this content.</div>';
                return;
            }

            let html = '';


            fragments.forEach(fragment => {
                // Determine fragment type class for styling
                const typeClass = fragment.fragment_type.toLowerCase().replace(/\s+/g, '_');
                let score = undefined;

                // Determine current ranking display
                let rankingDisplay = '';
                if (fragment.avg_rank_score !== null && fragment.avg_rank_score !== undefined) {
                    score = fragment.avg_rank_score;
                    let rankingBadge = '';
                    if (score >= 4) {
                        rankingBadge = '<span class="badge bg-success">Good</span>';
                    } else if (score >= 2.5) {
                        rankingBadge = '<span class="badge bg-warning">Ok</span>';
                    } else if (score !== undefined) {
                        rankingBadge = '<span class="badge bg-danger">Bad</span>';
                    }
                    rankingDisplay = `${rankingBadge} <small class="text-muted">(${score.toFixed(1)} / ${fragment.ranking_count} votes)</small>`;
                } else {
                    rankingDisplay = '<small class="text-muted">Not rated</small>';
                }

                html += `
                    <div class="card fragment-card ${typeClass} mb-3">
                        <div class="card-header bg-light py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-${getBadgeColor(fragment.fragment_type)}">
                                        ${fragment.fragment_type}
                                    </span>
                                    <span class="ms-2">${rankingDisplay}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-1 ${!fragment.assets || !fragment.assets.length ? 'disabled' : ''}" title="Play Audio"
                                           onclick="playFragmentAudio(${fragment.id})" data-fragment-id="${fragment.id}">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" title="Edit Fragment">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="/admin/fragments/${fragment.id}/detail" class="btn btn-sm btn-outline-info" title="View Fragment Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body py-3">
                            <div class="row">
                                <div class="col-md-5">
                                    <h5 class="mb-2">${fragment.native_text}</h5>
                                    ${fragment.ipa ? `<p class="mb-2 text-muted"><em>${fragment.ipa}</em></p>` : ''}
                                </div>
                                <div class="col-md-7">
                                    <p class="mb-1">${fragment.body_text}</p>
                                    ${fragment.extra ? `<p class="mb-0 text-muted"><small>${fragment.extra}</small></p>` : ''}
                                </div>
                            </div>
                            <div class="d-flex justify-content-start gap-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(${fragment.id}, 1)">Bad${score < 2.5 ? ' ✅' : ''}</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(${fragment.id}, 3)">Ok${score >= 2.5 && score < 4 ? ' ✅' : ''}</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(${fragment.id}, 5)">Good${score >= 4 ? ' ✅' : ''}</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('fragmentsList').innerHTML = html;
        }

        // Helper function to get badge color based on fragment type
        function getBadgeColor(fragmentType) {
            const typeColors = {
                'vocabulary': 'primary',
                'real_life_example': 'success',
                'pronunciation': 'danger',
                'grammar': 'info',
                'phrase': 'warning'
            };

            return typeColors[fragmentType.toLowerCase()] || 'secondary';
        }

        // Fragment audio player
        async function playFragmentAudio(fragmentId) {
            try {
                // Get the button that was clicked
                const button = document.querySelector(`button[data-fragment-id="${fragmentId}"]`);

                // First fetch the fragment assets to get asset ID
                const response = await fetch(`/fragments/${fragmentId}/assets?asset_type=audio&active_only=true`);
                const data = await response.json();

                if (!data.assets || data.assets.length === 0) {
                    alert('No audio available for this fragment.');
                    return;
                }

                // Get first available audio asset
                const audioAsset = data.assets[0];

                // Create audio element if it doesn't exist
                let audioPlayer = document.getElementById('audioPlayer');
                if (!audioPlayer) {
                    audioPlayer = document.createElement('audio');
                    audioPlayer.id = 'audioPlayer';
                    document.body.appendChild(audioPlayer);

                    // Add ended event to reset buttons
                    audioPlayer.addEventListener('ended', function() {
                        // Reset all buttons to default state
                        document.querySelectorAll('.btn-playing').forEach(btn => {
                            btn.classList.remove('btn-playing');
                            const icon = btn.querySelector('i');
                            icon.className = 'fas fa-volume-up';
                            icon.classList.remove('icon-pulse');
                        });
                    });
                }

                // Highlight the active button
                document.querySelectorAll('.btn-playing').forEach(btn => {
                    btn.classList.remove('btn-playing');
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-volume-up';
                    icon.classList.remove('icon-pulse');
                });
                button.classList.add('btn-playing');
                const icon = button.querySelector('i');
                icon.className = 'fas fa-volume-high';
                icon.classList.add('icon-pulse');

                // Set source and play
                audioPlayer.src = `/fragments/assets/${audioAsset.id}`;

                // Play with promise to handle errors
                const playPromise = audioPlayer.play();

                if (playPromise !== undefined) {
                    playPromise
                        .then(_ => {
                            // Audio started playing
                            console.log('Audio playback started');
                        })
                        .catch(error => {
                            console.error('Error playing audio:', error);
                            alert('Error playing audio. Please try again.');
                            button.classList.remove('btn-playing');
                            const icon = button.querySelector('i');
                            icon.className = 'fas fa-volume-up';
                            icon.classList.remove('icon-pulse');
                        });
                }
            } catch (error) {
                console.error('Error loading audio:', error);
                alert('Error loading audio. Please try again.');
                // Reset button state on error
                document.querySelectorAll('.btn-playing').forEach(btn => {
                    btn.classList.remove('btn-playing');
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-volume-up';
                    icon.classList.remove('icon-pulse');
                });
            }
        }

        async function setFragmentRanking(fragmentId, rankScore) {
            try {
                const response = await fetch(`/fragments/${fragmentId}/ranking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rank_score: parseFloat(rankScore) })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    return;
                }

                const data = await response.json();
                console.log("Success:", data);
                loadContentFragments();
            } catch (error) {
                console.error("Request failed:", error);
            }
        }

        function getCurrentContentId() {
            return parseInt(window.location.pathname.split('/').filter(v => /^\d+$/.test(v))[0], 10);
        }

        function navigateToNext() {
            window.location.href = `/admin/learning-content/${getCurrentContentId() + 1}/detail`;
        }

        function navigateToPrevious() {
            window.location.href = `/admin/learning-content/${getCurrentContentId() - 1}/detail`;
        }
        
        function finishReview() {
            // Reload the page to get the next review item
            window.location.reload();
        }
        
        async function loadNextReviewContent() {
            showLoading(true);
            try {
                const response = await fetch('/learning-content/next-review');
                
                if (!response.ok) {
                    if (response.status === 404) {
                        document.getElementById('contentDetails').innerHTML =
                            '<div class="alert alert-info">' +
                            '<h4><i class="fas fa-check-circle"></i> Review Complete</h4>' +
                            '<p>Great job! All available content has been reviewed.</p>' +
                            '<p>No more content needs review at this time.</p>' +
                            '<a href="/admin/learning-content" class="btn btn-primary">Back to Learning Content</a>' +
                            '</div>';
                        document.getElementById('fragmentsList').innerHTML = '';
                    } else {
                        document.getElementById('contentDetails').innerHTML =
                            '<div class="alert alert-danger">' +
                            `<h4><i class="fas fa-exclamation-circle"></i> Error (${response.status})</h4>` +
                            '<p>There was a problem loading the next review content.</p>' +
                            '</div>';
                    }
                    return;
                }
                
                const content = await response.json();
                contentId = content.id;  // Set the content ID for this review item
                
                // Show review mode buttons
                document.getElementById('prevBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('finishReviewBtn').style.display = 'inline-block';
                
                // Display the content
                displayContentDetails(content);
                loadContentFragments();
            } catch (error) {
                console.error('Error loading next review content:', error);
                document.getElementById('contentDetails').innerHTML =
                    '<div class="alert alert-danger">' +
                    '<h4><i class="fas fa-exclamation-circle"></i> Error</h4>' +
                    '<p>There was a problem loading the next review content:</p>' +
                    `<pre class="text-danger">${error.message}</pre>` +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
