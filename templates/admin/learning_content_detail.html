<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Content Details - Anki Vector Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tag {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 0.8em;
        }
        .fragment-card {
            border-left: 4px solid #6c757d;
            margin-bottom: 15px;
        }
        .fragment-card.vocabulary {
            border-left-color: #0d6efd;
        }
        .fragment-card.real_life_example {
            border-left-color: #198754;
        }
        .fragment-card.pronunciation {
            border-left-color: #dc3545;
        }
        .fragment-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .loading-spinner {
            display: none;
        }
        .btn-playing {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }
        .btn-playing:hover {
            background-color: #157347;
            color: white;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .icon-pulse {
            animation: pulse 1s infinite;
            display: inline-block;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-brain"></i> Anki Vector Admin
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/admin">Dashboard</a>
                <a class="nav-link me-3" href="/admin/fragments">Fragments</a>
                <a class="nav-link active" href="/admin/learning-content">Learning Content</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <a href="/admin/learning-content" class="btn btn-outline-secondary mb-3">
                    <i class="fas fa-arrow-left"></i> Back to Learning Content
                </a>
                <button class="btn btn-outline-secondary mb-3" type="button" onclick="navigateToPrevious()">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="btn btn-outline-secondary mb-3" type="button" onclick="navigateToNext()">
                    <i class="fas fa-arrow-right"></i> Next
                </button>
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 id="contentTitle">Learning Content Details</h4>
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="contentDetails">
                        <!-- Content details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Fragments Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-puzzle-piece text-primary"></i> Related Fragments</h5>
                    </div>
                    <div class="card-body">
                        <div id="fragmentsList">
                            <!-- Fragments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get content ID from URL
        // url looks like /learning-content/52/detail
        const contentId = window.location.pathname.split('/').filter(v => /^\d+$/.test(v))[0];

        document.addEventListener('DOMContentLoaded', function() {
            loadContentDetails();
            loadContentFragments();
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowLeft') {
                navigateToPrevious();
            } else if (event.key === 'ArrowRight') {
                navigateToNext();
            }
        });

        // Show/hide loading
        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        async function loadContentDetails() {
            showLoading(true);
            try {
                const response = await fetch(`/learning-content/${contentId}`);

                if (!response.ok) {
                    // Handle 404 or other errors
                    if (response.status === 404) {
                        document.getElementById('contentDetails').innerHTML =
                            '<div class="alert alert-warning">' +
                            '<h4><i class="fas fa-exclamation-triangle"></i> Content Not Found</h4>' +
                            '<p>The learning content you\'re looking for doesn\'t exist.</p>' +
                            '<p>This may be because:</p>' +
                            '<ul>' +
                            '<li>The content was deleted</li>' +
                            '<li>The database is not properly set up</li>' +
                            '<li>The content ID is incorrect</li>' +
                            '</ul>' +
                            '</div>';
                    } else {
                        document.getElementById('contentDetails').innerHTML =
                            '<div class="alert alert-danger">' +
                            `<h4><i class="fas fa-exclamation-circle"></i> Error (${response.status})</h4>` +
                            '<p>There was a problem loading the content details. Please try again later.</p>' +
                            '</div>';
                    }
                    return;
                }

                const content = await response.json();
                displayContentDetails(content);
            } catch (error) {
                console.error('Error loading content details:', error);
                document.getElementById('contentDetails').innerHTML =
                    '<div class="alert alert-danger">' +
                    '<h4><i class="fas fa-exclamation-circle"></i> Error</h4>' +
                    '<p>There was a problem loading the content details:</p>' +
                    `<pre class="text-danger">${error.message}</pre>` +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }

        async function loadContentFragments() {
            showLoading(true);
            try {
                const response = await fetch(`/learning-content/${contentId}/fragments`);

                if (!response.ok) {
                    // Handle errors but don't show an alert - just show empty state
                    document.getElementById('fragmentsList').innerHTML =
                        '<div class="alert alert-info">' +
                        '<p><i class="fas fa-info-circle"></i> No fragments found for this content.</p>' +
                        '</div>';
                    return;
                }

                const fragments = await response.json();
                displayFragments(fragments);
            } catch (error) {
                console.error('Error loading fragments:', error);
                document.getElementById('fragmentsList').innerHTML =
                    '<div class="alert alert-info">' +
                    '<p><i class="fas fa-info-circle"></i> No fragments could be loaded at this time.</p>' +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }

        function displayContentDetails(content) {
            // Update page title
            document.title = `${content.title} - Learning Content Details`;
            document.getElementById('contentTitle').textContent = content.title;

            // Format tags for display
            const tagsHtml = content.tags ?
                content.tags.map(tag => `<span class="tag">${tag}</span>`).join('') :
                '<em class="text-muted">None</em>';

            let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <span class="badge bg-primary">${content.content_type}</span>
                            ${content.difficulty_level ?
                              `<span class="badge bg-warning ms-1">Level ${content.difficulty_level}</span>` : ''}
                            <span class="badge bg-secondary ms-1">${content.language}</span>
                        </div>
                        <p><strong>Tags:</strong> ${tagsHtml}</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-1"><small class="text-muted">Created: ${new Date(content.created_at).toLocaleDateString()}</small></p>
                        <p><small class="text-muted">Last Updated: ${new Date(content.updated_at).toLocaleDateString()}</small></p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <h6>Native Text:</h6>
                        <div class="p-3 bg-light rounded">${content.native_text || '<em class="text-muted">Not set</em>'}</div>
                    </div>
                    <div class="col-md-12">
                        <h6>Back Template:</h6>
                        <div class="p-3 bg-light rounded">${content.back_template || '<em class="text-muted">Not set</em>'}</div>
                    </div>
                </div>
            `;

            document.getElementById('contentDetails').innerHTML = html;
        }

        function displayFragments(fragments) {
            if (!fragments || fragments.length === 0) {
                document.getElementById('fragmentsList').innerHTML =
                    '<div class="alert alert-info">No fragments associated with this content.</div>';
                return;
            }

            let html = '';

            fragments.forEach(fragment => {
                // Determine fragment type class for styling
                const typeClass = fragment.fragment_type.toLowerCase().replace(/\s+/g, '_');

                html += `
                    <div class="card fragment-card ${typeClass} mb-3">
                        <div class="card-header bg-light py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-${getBadgeColor(fragment.fragment_type)}">
                                    ${fragment.fragment_type}
                                </span>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-1 ${!fragment.assets.length ? 'disabled' : ''}" title="Play Audio"
                                           onclick="playFragmentAudio(${fragment.id})" data-fragment-id="${fragment.id}">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" title="Edit Fragment">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="/admin/fragments/${fragment.id}/detail" class="btn btn-sm btn-outline-info" title="View Fragment Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body py-3">
                            <div class="row">
                                <div class="col-md-5">
                                    <h5 class="mb-2">${fragment.native_text}</h5>
                                    ${fragment.ipa ? `<p class="mb-2 text-muted"><em>${fragment.ipa}</em></p>` : ''}
                                </div>
                                <div class="col-md-7">
                                    <p class="mb-1">${fragment.body_text}</p>
                                    ${fragment.extra ? `<p class="mb-0 text-muted"><small>${fragment.extra}</small></p>` : ''}
                                </div>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(${fragment.id}, 1)">Bad</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(${fragment.id}, 3)">Ok</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(${fragment.id}, 5)">Good</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('fragmentsList').innerHTML = html;
        }

        // Helper function to get badge color based on fragment type
        function getBadgeColor(fragmentType) {
            const typeColors = {
                'vocabulary': 'primary',
                'real_life_example': 'success',
                'pronunciation': 'danger',
                'grammar': 'info',
                'phrase': 'warning'
            };

            return typeColors[fragmentType.toLowerCase()] || 'secondary';
        }

        // Fragment audio player
        async function playFragmentAudio(fragmentId) {
            try {
                // Get the button that was clicked
                const button = document.querySelector(`button[data-fragment-id="${fragmentId}"]`);

                // First fetch the fragment assets to get asset ID
                const response = await fetch(`/fragments/${fragmentId}/assets?asset_type=audio&active_only=true`);
                const data = await response.json();

                if (!data.assets || data.assets.length === 0) {
                    alert('No audio available for this fragment.');
                    return;
                }

                // Get first available audio asset
                const audioAsset = data.assets[0];

                // Create audio element if it doesn't exist
                let audioPlayer = document.getElementById('audioPlayer');
                if (!audioPlayer) {
                    audioPlayer = document.createElement('audio');
                    audioPlayer.id = 'audioPlayer';
                    document.body.appendChild(audioPlayer);

                    // Add ended event to reset buttons
                    audioPlayer.addEventListener('ended', function() {
                        // Reset all buttons to default state
                        document.querySelectorAll('.btn-playing').forEach(btn => {
                            btn.classList.remove('btn-playing');
                            const icon = btn.querySelector('i');
                            icon.className = 'fas fa-volume-up';
                            icon.classList.remove('icon-pulse');
                        });
                    });
                }

                // Highlight the active button
                document.querySelectorAll('.btn-playing').forEach(btn => {
                    btn.classList.remove('btn-playing');
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-volume-up';
                    icon.classList.remove('icon-pulse');
                });
                button.classList.add('btn-playing');
                const icon = button.querySelector('i');
                icon.className = 'fas fa-volume-high';
                icon.classList.add('icon-pulse');

                // Set source and play
                audioPlayer.src = `/fragments/assets/${audioAsset.id}`;

                // Play with promise to handle errors
                const playPromise = audioPlayer.play();

                if (playPromise !== undefined) {
                    playPromise
                        .then(_ => {
                            // Audio started playing
                            console.log('Audio playback started');
                        })
                        .catch(error => {
                            console.error('Error playing audio:', error);
                            alert('Error playing audio. Please try again.');
                            button.classList.remove('btn-playing');
                            const icon = button.querySelector('i');
                            icon.className = 'fas fa-volume-up';
                            icon.classList.remove('icon-pulse');
                        });
                }
            } catch (error) {
                console.error('Error loading audio:', error);
                alert('Error loading audio. Please try again.');
                // Reset button state on error
                document.querySelectorAll('.btn-playing').forEach(btn => {
                    btn.classList.remove('btn-playing');
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-volume-up';
                    icon.classList.remove('icon-pulse');
                });
            }
        }

        async function setFragmentRanking(fragmentId, rankScore) {
            try {
                const response = await fetch(`/fragments/${fragmentId}/ranking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rank_score: parseFloat(rankScore) })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    return;
                }

                const data = await response.json();
                console.log("Success:", data);
                loadContentFragments();
            } catch (error) {
                console.error("Request failed:", error);
            }
        }

        function getCurrentContentId() {
            return parseInt(window.location.pathname.split('/').filter(v => /^\d+$/.test(v))[0], 10);
        }

        function navigateToNext() {
            window.location.href = `/admin/learning-content/${getCurrentContentId() + 1}/detail`;
        }

        function navigateToPrevious() {
            window.location.href = `/admin/learning-content/${getCurrentContentId() - 1}/detail`;
        }
    </script>
</body>
</html>
