<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Content Management - Anki Vector Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .template-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        .tag {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 0.8em;
        }
        .content-type-badge {
            font-size: 0.7em;
            padding: 2px 6px;
        }
        .fragment-token {
            background: #fff3cd;
            padding: 1px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.8em;
        }
        .action-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .loading-spinner {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-brain"></i> Anki Vector Admin
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/admin">Dashboard</a>
                <a class="nav-link me-3" href="/admin/fragments">Fragments</a>
                <a class="nav-link active" href="/admin/learning-content">Learning Content</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1><i class="fas fa-graduation-cap text-primary"></i> Learning Content Management</h1>
                        <p class="text-muted">Manage abstract learning content and export to different formats</p>
                    </div>
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4" id="statsRow">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter"></i> Filters & Search</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="contentTypeFilter" class="form-label">Content Type</label>
                        <select class="form-select" id="contentTypeFilter">
                            <option value="">All Types</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="languageFilter" class="form-label">Language</label>
                        <select class="form-select" id="languageFilter">
                            <option value="">All Languages</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Search Text</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search title, templates...">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" id="searchBtn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content List -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> Learning Content 
                    <span id="totalCount" class="badge bg-secondary ms-2">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div id="contentList">
                    <!-- Content will be loaded here -->
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Content pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be loaded here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Edit Content Modal -->
    <div class="modal fade" id="editContentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Learning Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editContentForm">
                        <input type="hidden" id="editContentId">
                        
                        <div class="row">
                            <div class="col-md-8">
                                <label for="editTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="editTitle" required>
                            </div>
                            <div class="col-md-4">
                                <label for="editContentType" class="form-label">Content Type</label>
                                <select class="form-select" id="editContentType" required>
                                    <option value="vocabulary">Vocabulary</option>
                                    <option value="pronoun">Pronoun</option>
                                    <option value="question_word">Question Word</option>
                                    <option value="conjunction">Conjunction</option>
                                    <option value="adverb">Adverb</option>
                                    <option value="vocabulary_variants">Vocabulary Variants</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="editLanguage" class="form-label">Language</label>
                                <select class="form-select" id="editLanguage" required>
                                    <option value="thai">Thai</option>
                                    <option value="english">English</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editDifficultyLevel" class="form-label">Difficulty Level</label>
                                <select class="form-select" id="editDifficultyLevel">
                                    <option value="">Not Set</option>
                                    <option value="1">1 - Beginner</option>
                                    <option value="2">2 - Elementary</option>
                                    <option value="3">3 - Intermediate</option>
                                    <option value="4">4 - Advanced</option>
                                    <option value="5">5 - Expert</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label for="editTags" class="form-label">Tags (comma-separated)</label>
                            <input type="text" class="form-control" id="editTags" placeholder="tag1, tag2, tag3">
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <label for="editFrontTemplate" class="form-label">Front Template</label>
                                <textarea class="form-control" id="editFrontTemplate" rows="3" placeholder="Use {{ '{{' }}fragment:123{{ '}}' }} for fragment tokens"></textarea>
                                <small class="form-text text-muted">What appears on the front of the card</small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <label for="editBackTemplate" class="form-label">Back Template</label>
                                <textarea class="form-control" id="editBackTemplate" rows="3" placeholder="Use {{ '{{' }}fragment:123{{ '}}' }} for fragment tokens"></textarea>
                                <small class="form-text text-muted">What appears on the back of the card</small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <label for="editExampleTemplate" class="form-label">Example Template</label>
                                <textarea class="form-control" id="editExampleTemplate" rows="6" placeholder="Use {{ '{{' }}fragment:123{{ '}}' }} for fragment tokens"></textarea>
                                <small class="form-text text-muted">Rich examples with pronunciation, usage, etc.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveContentBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        let currentFilters = {};

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadContent();
            
            // Event listeners
            document.getElementById('searchBtn').addEventListener('click', handleSearch);
            document.getElementById('saveContentBtn').addEventListener('click', handleSaveContent);
            
            // Enter key search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
        });

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/learning-content/stats');
                const data = await response.json();
                
                let statsHtml = '';
                
                // Content types card
                statsHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-tags text-primary"></i> Content Types</h6>
                                <div class="row">`;
                
                data.content_types.forEach(type => {
                    statsHtml += `
                        <div class="col-6">
                            <small>${type.content_type}: <strong>${type.count}</strong></small>
                        </div>`;
                });
                
                statsHtml += `</div></div></div></div>`;
                
                // Languages card
                statsHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-globe text-success"></i> Languages</h6>
                                <div class="row">`;
                
                data.languages.forEach(lang => {
                    statsHtml += `
                        <div class="col-6">
                            <small>${lang.language}: <strong>${lang.count}</strong></small>
                        </div>`;
                });
                
                statsHtml += `</div></div></div></div>`;
                
                document.getElementById('statsRow').innerHTML = statsHtml;
                
                // Populate filter dropdowns
                populateFilterDropdowns(data.content_types, data.languages);
                
            } catch (error) {
                console.error('Error loading stats:', error);
                // Show error message and set defaults
                document.getElementById('statsRow').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Error loading statistics. Please refresh the page.
                        </div>
                    </div>
                `;
                // Set empty defaults for filter dropdowns
                populateFilterDropdowns([], []);
            }
        }

        // Populate filter dropdowns
        function populateFilterDropdowns(contentTypes, languages) {
            const contentTypeSelect = document.getElementById('contentTypeFilter');
            const languageSelect = document.getElementById('languageFilter');
            
            contentTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.content_type;
                option.textContent = type.content_type + ' (' + type.count + ')';
                contentTypeSelect.appendChild(option);
            });
            
            languages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.language;
                option.textContent = lang.language + ' (' + lang.count + ')';
                languageSelect.appendChild(option);
            });
        }

        // Handle search
        function handleSearch() {
            currentPage = 1;
            currentFilters = {
                content_type: document.getElementById('contentTypeFilter').value,
                language: document.getElementById('languageFilter').value,
                search: document.getElementById('searchInput').value
            };
            loadContent();
        }

        // Load content with filters
        async function loadContent() {
            showLoading(true);
            
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    page_size: 10
                });
                
                if (currentFilters.content_type) params.append('content_type', currentFilters.content_type);
                if (currentFilters.language) params.append('language', currentFilters.language);
                if (currentFilters.search) params.append('search', currentFilters.search);
                
                const response = await fetch('/api/learning-content?' + params);
                const data = await response.json();
                
                displayContent(data.content);
                displayPagination(data.pagination);
                
                document.getElementById('totalCount').textContent = data.pagination.total_count;
                
            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('contentList').innerHTML = 
                    '<div class="alert alert-danger">Error loading content: ' + error.message + '</div>';
            } finally {
                showLoading(false);
            }
        }

        // Display content
        function displayContent(content) {
            if (!content || content.length === 0) {
                document.getElementById('contentList').innerHTML = 
                    '<div class="alert alert-info">No content found matching your criteria.</div>';
                return;
            }
            
            let html = '';
            
            content.forEach(item => {
                const tags = item.tags || [];
                const tagsHtml = tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        ${item.title}
                                        <span class="badge bg-primary content-type-badge">${item.content_type}</span>
                                        ${item.difficulty_level ? `<span class="badge bg-warning content-type-badge">Level ${item.difficulty_level}</span>` : ''}
                                    </h6>
                                    <p class="text-muted small mb-2">
                                        Language: ${item.language} | 
                                        Created: ${new Date(item.created_at).toLocaleDateString()} |
                                        Linked Anki Cards: ${item.linked_anki_cards_count}
                                    </p>
                                    ${tagsHtml ? `<div class="mb-2">${tagsHtml}</div>` : ''}
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <small class="text-muted">Front:</small>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" disabled ${item.has_front_template ? 'checked' : ''}>
                                                <label class="form-check-label small">Has Template</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Back:</small>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" disabled ${item.has_back_template ? 'checked' : ''}>
                                                <label class="form-check-label small">Has Template</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Example:</small>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" disabled ${item.has_example_template ? 'checked' : ''}>
                                                <label class="form-check-label small">Has Template</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editContent(${item.id})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportContent(${item.id}, 'anki')">
                                            <i class="fas fa-file-export"></i> Export Anki
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" onclick="exportContent(${item.id}, 'html')">
                                            <i class="fas fa-code"></i> HTML
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="exportContent(${item.id}, 'api-json')">
                                            <i class="fas fa-file-code"></i> JSON
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="previewContent(${item.id})">
                                            <i class="fas fa-eye"></i> Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            
            document.getElementById('contentList').innerHTML = html;
        }

        // Display pagination
        function displayPagination(pagination) {
            let html = '';
            
            if (pagination.has_prev) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
            }
            
            for (let i = 1; i <= pagination.total_pages; i++) {
                if (i === currentPage) {
                    html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
                }
            }
            
            if (pagination.has_next) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
            }
            
            document.getElementById('pagination').innerHTML = html;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadContent();
        }

        // Show/hide loading
        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        // Edit content
        async function editContent(contentId) {
            try {
                const response = await fetch(`/api/learning-content/${contentId}`);
                const content = await response.json();
                
                // Populate form
                document.getElementById('editContentId').value = content.id;
                document.getElementById('editTitle').value = content.title;
                document.getElementById('editContentType').value = content.content_type;
                document.getElementById('editLanguage').value = content.language;
                document.getElementById('editDifficultyLevel').value = content.difficulty_level || '';
                document.getElementById('editTags').value = content.tags ? content.tags.join(', ') : '';
                document.getElementById('editFrontTemplate').value = content.front_template || '';
                document.getElementById('editBackTemplate').value = content.back_template || '';
                document.getElementById('editExampleTemplate').value = content.example_template || '';
                
                // Show modal
                new bootstrap.Modal(document.getElementById('editContentModal')).show();
                
            } catch (error) {
                console.error('Error loading content for edit:', error);
                alert('Error loading content: ' + error.message);
            }
        }

        // Save content
        async function handleSaveContent() {
            const contentId = document.getElementById('editContentId').value;
            const updates = {
                title: document.getElementById('editTitle').value,
                content_type: document.getElementById('editContentType').value,
                language: document.getElementById('editLanguage').value,
                difficulty_level: document.getElementById('editDifficultyLevel').value ? parseInt(document.getElementById('editDifficultyLevel').value) : null,
                tags: document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t),
                front_template: document.getElementById('editFrontTemplate').value,
                back_template: document.getElementById('editBackTemplate').value,
                example_template: document.getElementById('editExampleTemplate').value
            };
            
            try {
                const response = await fetch(`/api/learning-content/${contentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Content updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editContentModal')).hide();
                    loadContent(); // Reload the list
                } else {
                    alert('Error updating content: ' + result.detail);
                }
                
            } catch (error) {
                console.error('Error saving content:', error);
                alert('Error saving content: ' + error.message);
            }
        }

        // Export content
        async function exportContent(contentId, format) {
            try {
                showLoading(true);
                const response = await fetch(`/api/learning-content/${contentId}/export/${format}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (format === 'anki') {
                        alert(`Anki export successful! Action: ${result.action}`);
                        if (result.updated_cards) {
                            alert(`Updated cards: ${result.updated_cards.join(', ')}`);
                        }
                    } else if (format === 'html') {
                        // Show HTML in new window
                        const newWindow = window.open();
                        newWindow.document.write(result.html);
                        newWindow.document.close();
                    } else if (format === 'api-json') {
                        // Show JSON in new window
                        const newWindow = window.open();
                        newWindow.document.write('<pre>' + JSON.stringify(result, null, 2) + '</pre>');
                        newWindow.document.close();
                    }
                } else {
                    alert('Export error: ' + result.detail);
                }
                
            } catch (error) {
                console.error('Error exporting content:', error);
                alert('Export error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Preview content (placeholder)
        function previewContent(contentId) {
            alert('Preview functionality coming soon!');
        }
    </script>
</body>
</html> 
