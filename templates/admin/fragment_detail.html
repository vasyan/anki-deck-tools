<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Details - Anki Vector Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tag {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 0.8em;
        }
        .fragment-card {
            border-left: 4px solid #6c757d;
            margin-bottom: 15px;
        }
        .fragment-card.vocabulary {
            border-left-color: #0d6efd;
        }
        .fragment-card.real_life_example {
            border-left-color: #198754;
        }
        .fragment-card.pronunciation {
            border-left-color: #dc3545;
        }
        .fragment-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .loading-spinner {
            display: none;
        }
        .btn-playing {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }
        .btn-playing:hover {
            background-color: #157347;
            color: white;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .icon-pulse {
            animation: pulse 1s infinite;
            display: inline-block;
        }
        .asset-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .metadata-card {
            background-color: #f8f9fa;
            border-left: 4px solid #17a2b8;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-brain"></i> Anki Vector Admin
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/admin">Dashboard</a>
                <a class="nav-link active me-3" href="/admin/fragments">Fragments</a>
                <a class="nav-link" href="/admin/learning-content">Learning Content</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <a href="/admin/fragments" class="btn btn-outline-secondary mb-3">
                    <i class="fas fa-arrow-left"></i> Back to Fragments
                </a>
                <button class="btn btn-outline-secondary mb-3" type="button" onclick="navigateToPreviousFragment()">
                    <i class="fas fa-arrow-left"></i> Previous Fragment
                </button>
                <button class="btn btn-outline-secondary mb-3" type="button" onclick="navigateToNextFragment()">
                    <i class="fas fa-arrow-right"></i> Next Fragment
                </button>
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 id="fragmentTitle">Fragment Details</h4>
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="fragmentDetails">
                        <!-- Fragment details will be loaded here -->
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2">
                            <strong>Learning Content:</strong>
                            <span id="main-learning-content-title">Loading ...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(1)">Bad</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(3)">Ok</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="setFragmentRanking(5)">Good</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assets Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-alt text-primary"></i> Fragment Assets</h5>
                    </div>
                    <div class="card-body">
                        <div id="assetsList">
                            <!-- Assets will be loaded here -->
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" id="generateAssetButton" onclick="generateAssetForFragment()">Generate Asset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning Content Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-book text-primary"></i> Related Learning Content</h5>
                    </div>
                    <div class="card-body">
                        <div id="learningContentList">
                            <!-- Learning content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get fragment ID from URL
        const fragmentId = window.location.pathname.split('/').filter(v => /^\d+$/.test(v))[0];

        document.addEventListener('DOMContentLoaded', function() {
            loadFragmentDetails();
            loadFragmentAssets();
            loadRelatedLearningContent();
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowLeft') {
                navigateToPreviousFragment();
            } else if (event.key === 'ArrowRight') {
                navigateToNextFragment();
            }
        });

        // Show/hide loading
        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        async function loadFragmentDetails() {
            showLoading(true);
            try {
                const response = await fetch(`/fragments/${fragmentId}`);

                if (!response.ok) {
                    // Handle 404 or other errors
                    if (response.status === 404) {
                        document.getElementById('fragmentDetails').innerHTML =
                            '<div class="alert alert-warning">' +
                            '<h4><i class="fas fa-exclamation-triangle"></i> Fragment Not Found</h4>' +
                            '<p>The fragment you\'re looking for doesn\'t exist.</p>' +
                            '</div>';
                    } else {
                        document.getElementById('fragmentDetails').innerHTML =
                            '<div class="alert alert-danger">' +
                            `<h4><i class="fas fa-exclamation-circle"></i> Error (${response.status})</h4>` +
                            '<p>There was a problem loading the fragment details. Please try again later.</p>' +
                            '</div>';
                    }
                    return;
                }

                const fragment = await response.json();
                displayFragmentDetails(fragment);
            } catch (error) {
                console.error('Error loading fragment details:', error);
                document.getElementById('fragmentDetails').innerHTML =
                    '<div class="alert alert-danger">' +
                    '<h4><i class="fas fa-exclamation-circle"></i> Error</h4>' +
                    '<p>There was a problem loading the fragment details:</p>' +
                    `<pre class="text-danger">${error.message}</pre>` +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }

        async function loadFragmentAssets() {
            showLoading(true);
            try {
                const response = await fetch(`/fragments/${fragmentId}/assets`);

                if (!response.ok) {
                    // Handle errors but don't show an alert - just show empty state
                    document.getElementById('assetsList').innerHTML =
                        '<div class="alert alert-info">' +
                        '<p><i class="fas fa-info-circle"></i> No assets found for this fragment.</p>' +
                        '</div>';
                    return;
                }

                const data = await response.json();
                if (!data.assets || data.assets.length === 0) {
                    document.getElementById('assetsList').innerHTML =
                        '<div class="alert alert-info">' +
                        '<p><i class="fas fa-info-circle"></i> No assets associated with this fragment.</p>' +
                        '</div>';
                    return;
                }

                displayAssets(data.assets);
            } catch (error) {
                console.error('Error loading assets:', error);
                document.getElementById('assetsList').innerHTML =
                    '<div class="alert alert-info">' +
                    '<p><i class="fas fa-info-circle"></i> No assets could be loaded at this time.</p>' +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }

        async function loadRelatedLearningContent() {
            showLoading(true);
            try {
                const response = await fetch(`/fragments/${fragmentId}/learning-content`);

                if (!response.ok) {
                    // Handle errors but don't show an alert - just show empty state
                    document.getElementById('learningContentList').innerHTML =
                        '<div class="alert alert-info">' +
                        '<p><i class="fas fa-info-circle"></i> No learning content found for this fragment.</p>' +
                        '</div>';
                    return;
                }

                const data = await response.json();
                if (!data.learning_content || data.learning_content.length === 0) {
                    document.getElementById('learningContentList').innerHTML =
                        '<div class="alert alert-info">' +
                        '<p><i class="fas fa-info-circle"></i> No learning content associated with this fragment.</p>' +
                        '</div>';
                    return;
                }

                displayLearningContent(data.learning_content);
            } catch (error) {
                console.error('Error loading learning content:', error);
                document.getElementById('learningContentList').innerHTML =
                    '<div class="alert alert-info">' +
                    '<p><i class="fas fa-info-circle"></i> No learning content could be loaded at this time.</p>' +
                    '</div>';
            } finally {
                showLoading(false);
            }
        }

        function displayFragmentDetails(fragment) {
            // Update page title
            document.title = `${fragment.native_text || 'Fragment'} - Fragment Details`;
            document.getElementById('fragmentTitle').textContent = fragment.native_text || 'Fragment Details';

            let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <span class="badge bg-primary">${fragment.fragment_type || 'Unknown Type'}</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-1"><small class="text-muted">Created: ${new Date(fragment.created_at).toLocaleDateString()}</small></p>
                        <p><small class="text-muted">Last Updated: ${new Date(fragment.updated_at || fragment.created_at).toLocaleDateString()}</small></p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Native Text:</h6>
                        <div class="p-3 bg-light rounded">${fragment.native_text || '<em class="text-muted">Not set</em>'}</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Body Text:</h6>
                        <div class="p-3 bg-light rounded">${fragment.body_text || '<em class="text-muted">Not set</em>'}</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>IPA:</h6>
                        <div class="p-3 bg-light rounded">${fragment.ipa || '<em class="text-muted">Not set</em>'}</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Extra Information:</h6>
                        <div class="p-3 bg-light rounded">${fragment.extra || '<em class="text-muted">Not set</em>'}</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Fragment Ranking:</h6>
                        <div class="p-3 bg-light rounded">
                            ${getRankingDisplay(fragment.avg_rank_score, fragment.ranking_count)}
                        </div>
                    </div>
                </div>
            `;

            // Add metadata section if available
            if (fragment.metadata && Object.keys(fragment.metadata).length > 0) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Metadata:</h6>
                            <div class="p-3 bg-light rounded metadata-card">
                                <pre class="mb-0">${JSON.stringify(fragment.metadata, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('fragmentDetails').innerHTML = html;
        }

        function displayAssets(assets) {
            let html = '<div class="row">';

            assets.forEach(asset => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="asset-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <span class="badge bg-${getAssetTypeBadge(asset.asset_type)}">${asset.asset_type}</span>
                                    Asset #${asset.id}
                                </h6>
                                <div>
                                    ${asset.asset_type === 'audio' ?
                                        `<button class="btn btn-sm btn-outline-secondary"
                                            onclick="playAssetAudio(${asset.id})" data-asset-id="${asset.id}">
                                            <i class="fas fa-volume-up"></i>
                                        </button>` :
                                        ''
                                    }
                                </div>
                            </div>
                            <p class="mb-0"><small class="text-muted">Created: ${new Date(asset.created_at).toLocaleDateString()}</small></p>
                            <p class="mb-0"><small class="text-muted">Size: ${formatBytes(asset.asset_data_size || 0)}</small></p>
                            <p class="mb-0"><small class="text-muted">Ranking: ${asset.avg_rank_score || 0}</small></p>

                            ${asset.asset_metadata ?
                                `<div class="mt-2">
                                    <small><strong>Metadata:</strong></small>
                                    <pre class="p-2 bg-light rounded small mb-0">${JSON.stringify(asset.asset_metadata, null, 2)}</pre>
                                </div>` :
                                ''
                            }
                            <div class="mt-2">
                                <small><strong>Ranking:</strong></small>
                                <input type="number" class="form-control" id="rankingInput_${asset.id}" value="${asset.avg_rank_score || 0}">
                                <button class="btn btn-sm btn-outline-primary" onclick="setAssetRanking(${asset.id})">Set Ranking</button>
                            </div>
                            <div class="flex">
                                <button class="btn btn-sm btn-outline-secondary" onclick="setAssetRanking(${asset.id}, 1)">Bad</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setAssetRanking(${asset.id}, 3)">Ok</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setAssetRanking(${asset.id}, 5)">Good</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('assetsList').innerHTML = html;
        }

        function displayLearningContent(learningContents) {
            let html = '';

            learningContents.forEach(content => {
                // Format tags for display
                const tagsHtml = content.tags ?
                    content.tags.map(tag => `<span class="tag">${tag}</span>`).join('') :
                    '<em class="text-muted">None</em>';

                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${content.title}</h5>
                                <a href="/admin/learning-content/${content.id}/detail" class="btn btn-sm btn-primary">
                                    View Details
                                </a>
                            </div>
                        </div>
                        <div class="card-body py-3">
                            <div class="mb-2">
                                <span class="badge bg-primary">${content.content_type}</span>
                                ${content.difficulty_level ?
                                `<span class="badge bg-warning ms-1">Level ${content.difficulty_level}</span>` : ''}
                                <span class="badge bg-secondary ms-1">${content.language}</span>
                            </div>
                            <p><strong>Tags:</strong> ${tagsHtml}</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Native Text:</h6>
                                    <div class="p-2 bg-light rounded">${content.native_text || '<em class="text-muted">Not set</em>'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (learningContents.length > 0) {
                document.getElementById('main-learning-content-title').textContent = learningContents[0].title;
            }

            document.getElementById('learningContentList').innerHTML = html;

        }

        // Helper function to get badge color for asset type
        function getAssetTypeBadge(assetType) {
            const typeColors = {
                'audio': 'danger',
                'image': 'primary',
                'video': 'success'
            };

            return typeColors[assetType] || 'secondary';
        }
        
        // Helper function to display ranking
        function getRankingDisplay(avgRankScore, rankingCount) {
            if (avgRankScore === null || avgRankScore === undefined) {
                return '<em class="text-muted">Not rated</em>';
            }
            
            const score = avgRankScore;
            let rankingBadge = '';
            if (score >= 4) {
                rankingBadge = '<span class="badge bg-success">Good</span>';
            } else if (score >= 2.5) {
                rankingBadge = '<span class="badge bg-warning">Ok</span>';
            } else {
                rankingBadge = '<span class="badge bg-danger">Bad</span>';
            }
            
            return `${rankingBadge} <span class="text-muted">(${score.toFixed(1)} avg from ${rankingCount} votes)</span>`;
        }

        // Helper function to format byte sizes
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        async function setAssetRanking(assetId, rankScore) {
            try {
                const ranking = rankScore || document.getElementById(`rankingInput_${assetId}`).value;
                const response = await fetch(`/assets/${assetId}/ranking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rank_score: parseFloat(ranking) })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    return;
                }

                const data = await response.json();
                console.log("Success:", data);
                loadFragmentAssets();
            } catch (error) {
                console.error("Request failed:", error);
            }
        }

        // Asset audio player
        async function playAssetAudio(assetId) {
            try {
                // Get the button that was clicked
                const button = document.querySelector(`button[data-asset-id="${assetId}"]`);

                // Create audio element if it doesn't exist
                let audioPlayer = document.getElementById('audioPlayer');
                if (!audioPlayer) {
                    audioPlayer = document.createElement('audio');
                    audioPlayer.id = 'audioPlayer';
                    document.body.appendChild(audioPlayer);

                    // Add ended event to reset buttons
                    audioPlayer.addEventListener('ended', function() {
                        // Reset all buttons to default state
                        document.querySelectorAll('.btn-playing').forEach(btn => {
                            btn.classList.remove('btn-playing');
                            const icon = btn.querySelector('i');
                            icon.className = 'fas fa-volume-up';
                            icon.classList.remove('icon-pulse');
                        });
                    });
                }

                // Highlight the active button
                document.querySelectorAll('.btn-playing').forEach(btn => {
                    btn.classList.remove('btn-playing');
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-volume-up';
                    icon.classList.remove('icon-pulse');
                });
                button.classList.add('btn-playing');
                const icon = button.querySelector('i');
                icon.className = 'fas fa-volume-high';
                icon.classList.add('icon-pulse');

                // Set source and play
                audioPlayer.src = `/fragments/assets/${assetId}`;

                // Play with promise to handle errors
                const playPromise = audioPlayer.play();

                if (playPromise !== undefined) {
                    playPromise
                        .then(_ => {
                            // Audio started playing
                            console.log('Audio playback started');
                        })
                        .catch(error => {
                            console.error('Error playing audio:', error);
                            alert('Error playing audio. Please try again.');
                            button.classList.remove('btn-playing');
                            const icon = button.querySelector('i');
                            icon.className = 'fas fa-volume-up';
                            icon.classList.remove('icon-pulse');
                        });
                }
            } catch (error) {
                console.error('Error loading audio:', error);
                alert('Error loading audio. Please try again.');
                // Reset button state on error
                document.querySelectorAll('.btn-playing').forEach(btn => {
                    btn.classList.remove('btn-playing');
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-volume-up';
                    icon.classList.remove('icon-pulse');
                });
            }
        }

        function getCurrentFragmentId() {
            return parseInt(window.location.pathname.split('/').filter(v => /^\d+$/.test(v))[0], 10);
        }

        function navigateToNextFragment() {
            window.location.href = `/admin/fragments/${getCurrentFragmentId() + 1}/detail`;
        }

        function navigateToPreviousFragment() {
            window.location.href = `/admin/fragments/${getCurrentFragmentId() - 1}/detail`;
        }

        async function setFragmentRanking(rankScore) {
            try {
                const response = await fetch(`/fragments/${fragmentId}/ranking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rank_score: parseFloat(rankScore) })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    return;
                }

                const data = await response.json();
                console.log("Success:", data);
                loadFragmentDetails();
            } catch (error) {
                console.error("Request failed:", error);
            }
        }

        async function generateAssetForFragment() {
            document.getElementById('generateAssetButton').disabled = true;
            document.getElementById('generateAssetButton').innerHTML = 'Generating...';
            const response = await fetch(`/fragments/${fragmentId}/generate-asset`, {
                method: 'POST',
            });
            document.getElementById('generateAssetButton').innerHTML = 'Generate Asset';
            const data = await response.json();
            console.log("Success:", data);
            document.getElementById('generateAssetButton').disabled = false;
            loadFragmentAssets();
        }
    </script>
</body>
</html>
